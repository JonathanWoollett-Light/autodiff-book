<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Forward Automatic Differentiation - Automatic Differentiation in Rust</title>


        <!-- Custom HTML head -->

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="chapter_0.html"><strong aria-hidden="true">1.</strong> Setup</a></li><li class="chapter-item expanded "><a href="chapter_1.html" class="active"><strong aria-hidden="true">2.</strong> Forward Automatic Differentiation</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> Reverse Automatic Differentiation</div></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Automatic Differentiation in Rust</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js"                  integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js"    integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
            delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "\\(", right: "\\)", display: false},
                {left: "$", right: "$", display: false},
                {left: "\\[", right: "\\]", display: true}
            ]
        });
    });
</script>
<h1 id="forward-automatic-differentiation"><a class="header" href="#forward-automatic-differentiation">Forward Automatic Differentiation</a></h1>
<p>With some function $ f(x_1,x_2,...,x_n)=y_1,y_2,...,y_m $ the Big O'notation of forward automatic differentiation is $ O(n) $.</p>
<p>With reverse differentiation we need a run for each input.</p>
<p>In the simplest implementation with forward differentiation with each pass through our function we calculate the partial deriatives for one of our inputs (e.g. $\frac{\delta y_1}{\delta x_4}$,$\frac{\delta y_2}{\delta x_4}$,...,$\frac{\delta y_m}{\delta x_4}$).</p>
<p>In our specific case we have a function which has a single output (<code>e</code>), therefore we are concerned with computing $\frac{\delta e}{\delta a}$ and $\frac{\delta e}{\delta b}$.</p>
<p>For this simple implementation that caluclate the partial derivatives for 1 input in each run, we need to pass a set of seeds which effectively determine which input we are calculating the partial deratives for. In implementation this is multiple <code>f32</code>s where 1 is <code>1.</code> for the input we are calculating and the rest are <code>0.</code>.</p>
<p>E.g.</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn our_function(a: f32, b: f32, a_: f32 b_: f32) -&gt; (f32,f32)
<span class="boring">}
</span></code></pre></pre>
<p>In forward automatic differenation we accumulative the deriatives of input/s effectively summing their effects. To do this in each operation we multiply the cumulative derivative of an input for a variable by the deriative of the expression with respect to the aforementioned variable.</p>
<p>Consider the statements:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let a = x+2.;
// `x` has a constant affect on `a` and thus the derivative with respect to `x` is 
//  `1.`.
// We set a variable `x_a` equal to `1.`.
let b = a*3.;
// `a` has a linear affect on `b` and thus the derivative with respect to `a` is `3.`, 
//  but we don't care about the derivative of this internal variable.
// So now we want to get the cumulative derivative that accumulates the affects of `x` 
//  through these statements.
// Simply here we multiply the derivative of `b` with respect to `a` by the cumualtive 
//  deriative of `x` for `a` and thus we get the affect of `x` on `b`  (`db/dx`).
// We set a variable `x_b` equal to `3*x_a` (e.g. `3.*1.`) 
let c = x/2.;
// We do much the same as we did with `a`.
// We set a variable `x_c` equal to `0.5`.
let d = c+c.
// We do much the same as we did with `b`.
// d/dc(c+c)=2, the deriative of d with respect to c is `2.`.
// We set a variable `x_d` equal to `2.*x_c` (e.g. `2.*1.`)
let e = b+d;
// In this case we are affectively joining the 2 paths of `x` so far.
// Mathematicaly we would do `d/db(b+d)` and `d/dd(b+d)` with each multiplying the respective 
//  accumulative derivative for `x`, e.g. `1.*x_b` and `1.*x_d`.
// We set a variable `x_e` equal to `1.*x_b + 1.*d+x`
<span class="boring">}
</span></code></pre></pre>
<p>It may help your understanding to see that mathematically for each statement we are getting the derivative for <strong>every</strong> previous variable, e.g. for <code>let e = b + d</code> we are getting all the deriatives $\frac{\delta e}{\delta x}$, $\frac{\delta e}{\delta a}$, $\frac{\delta e}{\delta b}$, $\frac{\delta e}{\delta c}$ and $\frac{\delta e}{\delta d}$, and then multiplying all of these by their respective cumulative deriatives for the inputs $\delta x$, $\delta x_a$, $\delta x_b$, $\delta x_c$ and $\delta x_d$ (<code>x_</code>, <code>x_a</code>, <code>x_b</code>, <code>x_c</code> and <code>x_d</code>). But since all of these deriatives except the one which have components present in the statements work out to be 0, it means:</p>
<p>$$ \frac{\delta e}{\delta x} \cdot \delta x + \frac{\delta e}{\delta a} \cdot \delta x_a + \frac{\delta e}{\delta b} \cdot \delta x_b + \frac{\delta e}{\delta c} \cdot \delta x_c + \frac{\delta e}{\delta d} \cdot \delta x_d \equiv \frac{\delta e}{\delta b} \cdot \delta x_b + \frac{\delta e}{\delta d} \cdot \delta x_d $$</p>
<p>Since:</p>
<p>$$ \frac{\delta e}{\delta x} \cdot \delta x + \frac{\delta e}{\delta a} \cdot \delta x_a + \frac{\delta e}{\delta b} \cdot \delta x_b + \frac{\delta e}{\delta c} \cdot \delta x_c + \frac{\delta e}{\delta d} \cdot \delta x_d \equiv 0 \cdot \delta x + 0 \cdot \delta x_a + 1 \cdot \delta x_b + 0 \cdot \delta x_c + 1 \cdot \delta x_d $$</p>
<p>Thus while for any operation we are effectively summing all the derivative by all the cumulative derivatives, since we have specific knowledge about operations we optimize this by suming only the deriatives for which we know are useful (non-zero).</p>
<p>Understanding this helps you understand how this can be applied to any operation and automatic differentiation is not simply formed from some random rules.</p>
<h2 id="example-run"><a class="header" href="#example-run">Example run</a></h2>
<p>If we perform a run to obtain $\frac{\delta e}{\delta a}$ on the function given in <a href="./chapter_0.html">Setup</a> it follows:</p>
<h3 id="step-1"><a class="header" href="#step-1">Step 1</a></h3>
<p>$$ c = a \cdot b $$
$$ \therefore \frac{\delta c}{\delta a} = b, \frac{\delta c}{\delta b} = a $$
$$ \therefore \delta a_c = \frac{\delta c}{\delta a} \delta a + \frac{\delta c}{\delta b} \delta b $$
$$ \therefore \delta a_c = b \cdot \delta a + a \cdot \delta b $$</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let a_c = b * a_ + a * b_;
<span class="boring">}
</span></code></pre></pre>
<h3 id="step-2"><a class="header" href="#step-2">Step 2</a></h3>
<p>$$ d = \sin(a) $$
$$ \therefore \frac{\delta d}{\delta a} = \cos(a) $$
$$ \therefore \delta a_d = \cos(a) \cdot \delta a $$</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let a_d = a.cos() * a_;
<span class="boring">}
</span></code></pre></pre>
<h3 id="step-3"><a class="header" href="#step-3">Step 3</a></h3>
<p>$$ e = c + d $$
$$ \therefore \frac{\delta e}{\delta c} = 1, \frac{\delta e}{\delta d} = 1 $$
$$ \therefore \delta a_e = \frac{\delta e}{\delta c} \cdot \delta a_c + \frac{\delta e}{\delta d} \cdot \delta a_d $$
$$ \therefore \delta a_e = 1 \delta a_c + 1 \delta a_d $$</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let a_e = 1. * a_c + 1. * a_d;
<span class="boring">}
</span></code></pre></pre>
<h3 id="summary"><a class="header" href="#summary">Summary</a></h3>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let a_e = 1.*(b*a_ + a*b_) + 1.*(a.cos() * a_);
<span class="boring">}
</span></code></pre></pre>
<ul>
<li>
<p>When $\delta a=1$ (<code>a_=1</code>), $\delta b=0$ (<code>b_=0</code>):</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let a_e = b + a.cos();
<span class="boring">}
</span></code></pre></pre>
</li>
<li>
<p>When $a_d=0$ (<code>a_=0</code>) and $b_d=1$ (<code>b_=1</code>):</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let b_e = a;
<span class="boring">}
</span></code></pre></pre>
</li>
</ul>
<p>Therefore:</p>
<p>$$ \frac{\delta e}{\delta a} = b + \cos(a), \frac{\delta e}{\delta b} = a $$</p>
<p>Our final function being:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn our_autodiff_function(a: f32, b: f32, a_: f32, b_: f32) -&gt; (f32,f32) {
    let c = a * b;
    let c_ = a*b_ + b*a_; // This being `a_c` in our `a` specific example.
    let d = a.sin();
    let d_ = a.cos() * a_; // This being `a_d` in our `a` specific example.
    let e = c + d;
    let e_ = c_ + d_; // This being `a_e` in our `a` specific example.
    return (e, e_);
}
<span class="boring">}
</span></code></pre></pre>
<p>For calculating both derivatives $\frac{\delta e}{\delta a}$ and $\frac{\delta e}{\delta b}$:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn outer(a: f32, b: f32) -&gt; (f32,f32) {
    let a_e = our_autodiff_function(a,b,1.,0.);
    let b_e = our_autodiff_function(a,b,0.,1.);
    (a_e,b_e)
}
<span class="boring">}
</span></code></pre></pre>
<p>If we wanted to minimise the <code>e</code> we simply subtract a proportion of <code>a_e</code> and <code>b_e</code> from our input <code>a</code> and <code>b</code> values. Doing this is gradient descent.</p>
<h3 id="optimisation"><a class="header" href="#optimisation">Optimisation</a></h3>
<p>We can avoid re-calculating the intermediary values each run by splitting <code>our_autodiff_function</code> into 2 functions:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn forward(a: f32, b: f32) -&gt; (f32,f32,f32) {
    let c = a * b;
    let d = a.sin();
    let e = c + d;
    return (c,d,e);
}
fn backward(a: f32, b: f32, c: f32,d: f32,e: f32,a_,b_) -&gt; f32 {
    let c_ = a*b_ + b*a_;
    let d_ = a.cos() * a_;
    let e_ = c_ + d_;
    return e_;
}
fn outer(a: f32, b: f32) -&gt; (f32,f32,f32) {
    let (c,d,e) = forward(a,b);
    let a_d = backward(a,b,c,d,e,1.,0.);
    let b_d = backward(a,b,c,d,e,0.,1.);
    (e,a_d,b_d)
}
<span class="boring">}
</span></code></pre></pre>
<p>In this optimisation we have lost something however, now we need to hold the values of <code>a</code>, <code>b</code>, <code>c</code>, <code>d</code> and <code>e</code> in memory for the entire lifetime of our <code>outer</code> function. This could potentially be very expensive.</p>
<p>To avoid this and maintain our speedup we could rewrite it:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn forward_autodiff(a: f32, b: f32) -&gt; (f32,f32,f32) {
    let c = a * b;
    let (a_c, b_c) = (c_(a, b, 1., 0.), c_(a, b, 0., 1.));
    // `b` can be dropped here
    let d = a.sin();
    let (a_d, b_d) = (d_(a, 1.), d_(a, 0.));
    // `a` can be dropped here
    let e = c + d;
    // `c` and `d` can be dropped here
    let (a_e, b_e) = (e_(a_c,a_d), e_(b_c,b_d));
    return (e, a_e, b_e);
}
fn c_(a: f32, b: f32, a_: f32, b_: f32) -&gt; f32 { a*b_ + b*a_ }
fn d_(a: f32, a_:f32) -&gt; f32 { a.cos() * a_ }
fn e_(c_: f32, d_: f32) -&gt; f32 { c_ + d_ }

fn outer(a: f32, b: f32) -&gt; (f32,f32,f32) {
    let (e, a_e, b_e) = forward_autodiff(a, b);
    (e,a_e, b_e)
}
<span class="boring">}
</span></code></pre></pre>
<p>Now we only calculate <code>c</code>, <code>d</code> and <code>e</code> once and drop the variables asap to minimise memory usage.</p>
<p>While we have somewhat obfuscated the O'notation, at each derivative step we still need to calculate $n$ deriatives, so our function is still $O(n)$.</p>
<p>Further optimization is possible, although this is beyound what this introductory guide will cover.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="chapter_0.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="chapter_0.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
